<div class="external-orders">
    <header class="external-orders__header">
        <h2>Bestellübersichten</h2>
    </header>

    <main id="main" class="sw-page__main-content" tabindex="-1">
        <div class="external-orders__page">
            <sw-card class="external-orders__channels">
                <div class="external-orders__channel-tabs">
                    <button
                        v-for="channel in channels"
                        :key="channel.id"
                        class="external-orders__channel-tab"
                        :class="{ 'is--active': activeChannel === channel.id }"
                        type="button"
                        @click="activeChannel = channel.id; loadOrders()"
                    >
                        <span class="external-orders__channel-logo">
                            <img :src="channel.logo" :alt="channel.label" />
                        </span>
                        <span class="external-orders__channel-label">{{ channel.label }}</span>
                    </button>
                </div>
                <div class="external-orders__summary">
                    <div class="external-orders__summary-title">
                        <span>Bestellungen aus {{ activeChannelLabel }}</span>
                    </div>
                    <div class="external-orders__summary-metrics">
                        <div class="external-orders__summary-item">
                            <span class="external-orders__summary-label">Bestellungen</span>
                            <span class="external-orders__summary-value">{{ summary.orderCount }}</span>
                        </div>
                        <div class="external-orders__summary-item">
                            <span class="external-orders__summary-label">Gesamtumsatz</span>
                            <span class="external-orders__summary-value">{{ formatCurrency(summary.totalRevenue) }}</span>
                        </div>
                        <div class="external-orders__summary-item">
                            <span class="external-orders__summary-label">Stück</span>
                            <span class="external-orders__summary-value">{{ summary.totalItems }}</span>
                        </div>
                    </div>
                    <div class="external-orders__summary-actions">
                        <sw-button
                            variant="primary"
                            size="small"
                            @click="exportSelectedOrdersPdf"
                        >
                            <sw-icon name="regular-file-pdf" size="16" class="external-orders__download-icon" />
                            PDF herunterladen ({{ selectedOrders.length > 0 ? selectedOrders.length : filteredOrders.length }})
                        </sw-button>
                        <sw-button
                            variant="secondary"
                            size="small"
                            @click="exportSelectedOrdersExcel"
                        >
                            <sw-icon name="regular-file-excel" size="16" class="external-orders__download-icon" />
                            Excel herunterladen ({{ selectedOrders.length > 0 ? selectedOrders.length : filteredOrders.length }})
                        </sw-button>
                    </div>
                </div>
            </sw-card>

            <sw-card>
                <div class="external-orders__filters-bar">
                    <div class="external-orders__filters-row">
                        <div class="external-orders__filters">
                            <sw-button variant="primary" size="small">
                                <sw-icon name="regular-filter" size="16" />
                                Filter löschen
                            </sw-button>
                            <sw-datepicker placeholder="Start Datum" class="external-orders__date" size="small" date-type="date" />
                            <sw-datepicker placeholder="End Datum" class="external-orders__date" size="small" date-type="date" />
                            <sw-button variant="primary" size="small">Anwenden</sw-button>
                        </div>
                        <div class="external-orders__filters-actions">
                            <sw-search-bar
                                v-model="tableSearchTerm"
                                placeholder="Suche Bestellungen"
                                :show-search-types="false"
                                class="external-orders__search"
                                @search="onSearch"
                            />
                        </div>
                    </div>
                </div>

                <sw-data-grid
                    v-if="paginatedOrders.length > 0"
                    :data-source="paginatedOrders"
                    :columns="columns"
                    :loading="isLoading"
                    :sort-by="sortBy"
                    :sort-direction="sortDirection"
                    :show-selection="true"
                    class="external-orders__table"
                    identifier="external-orders"
                    @column-sort="onSortColumn"
                    @selection-change="onSelectionChange"
                >
                    <template #column-statusLabel="{ item }">
                        <sw-label :variant="statusVariant(item.status)" size="small">
                            {{ item.statusLabel }}
                        </sw-label>
                    </template>

                    <template #column-actions="{ item }">
                        <sw-button
                            variant="ghost"
                            size="small"
                            class="external-orders__action"
                            @click="openDetail(item)"
                        >
                            <sw-icon name="regular-eye" size="16" />
                        </sw-button>
                    </template>

                </sw-data-grid>
                <div
                    v-if="paginatedOrders.length > 0"
                    class="external-orders__pagination"
                >
                    <sw-pagination
                        :page="page"
                        :limit="limit"
                        :total="paginationTotal"
                        :total-visible="7"
                        @page-change="onPageChange"
                    />
                </div>
                <sw-empty-state
                    v-else
                    icon="regular-shopping-cart"
                    title="Keine Bestellungen gefunden"
                    subline="Es wurden keine Bestellungen für die aktuelle Auswahl geladen."
                />
            </sw-card>

            <sw-modal
                v-if="showDetailModal && selectedOrder"
                title="Bestellübersicht für {{ selectedOrder.orderNumber }}"
                variant="large"
                class="external-orders__detail-modal"
                @modal-close="closeDetail"
            >
                <div class="external-orders__detail">
                    <sw-card title="Zusätzliche Bestellinformationen" class="external-orders__detail-card">
                        <div class="external-orders__detail-grid">
                            <div class="external-orders__detail-section">
                                <h4>Kundendetails</h4>
                                <dl>
                                    <dt>Kundennummer</dt>
                                    <dd>{{ selectedOrder.customer.number }}</dd>
                                    <dt>Vorname</dt>
                                    <dd>{{ selectedOrder.customer.firstName }}</dd>
                                    <dt>Nachname</dt>
                                    <dd>{{ selectedOrder.customer.lastName }}</dd>
                                    <dt>Kunden-Mail-Adresse</dt>
                                    <dd>{{ selectedOrder.customer.email }}</dd>
                                    <dt>Kundengruppe</dt>
                                    <dd>{{ selectedOrder.customer.group }}</dd>
                                </dl>
                            </div>
                            <div class="external-orders__detail-section">
                                <h4>Zahlungsdetails</h4>
                                <dl>
                                    <dt>Zahlungsmethode</dt>
                                    <dd>{{ selectedOrder.payment.method }}</dd>
                                    <dt>Zahlungscode</dt>
                                    <dd>{{ selectedOrder.payment.code }}</dd>
                                    <dt>Fälligkeitsdatum</dt>
                                    <dd>{{ selectedOrder.payment.dueDate }}</dd>
                                    <dt>Ausstehender Betrag</dt>
                                    <dd>{{ selectedOrder.payment.outstanding }}</dd>
                                    <dt>Abgerechnet</dt>
                                    <dd>{{ selectedOrder.payment.settled }}</dd>
                                    <dt>Zusatzinfo</dt>
                                    <dd>{{ selectedOrder.payment.extra }}</dd>
                                </dl>
                            </div>
                            <div class="external-orders__detail-section">
                                <h4>Rechnungsanschrift</h4>
                                <dl>
                                    <dt>Straße</dt>
                                    <dd>{{ selectedOrder.billingAddress.street }}</dd>
                                    <dt>PLZ</dt>
                                    <dd>{{ selectedOrder.billingAddress.zip }}</dd>
                                    <dt>Stadt</dt>
                                    <dd>{{ selectedOrder.billingAddress.city }}</dd>
                                    <dt>Land</dt>
                                    <dd>{{ selectedOrder.billingAddress.country }}</dd>
                                </dl>
                            </div>
                            <div class="external-orders__detail-section">
                                <h4>Lieferanschrift</h4>
                                <dl>
                                    <dt>Lieferadresse</dt>
                                    <dd>{{ selectedOrder.shippingAddress.name }}</dd>
                                    <dt>Lieferstraße</dt>
                                    <dd>{{ selectedOrder.shippingAddress.street }}</dd>
                                    <dt>Postleitzahl/Stadt</dt>
                                    <dd>{{ selectedOrder.shippingAddress.zipCity }}</dd>
                                    <dt>Land</dt>
                                    <dd>{{ selectedOrder.shippingAddress.country }}</dd>
                                </dl>
                            </div>
                            <div class="external-orders__detail-section">
                                <h4>Weitere Details</h4>
                                <dl>
                                    <dt>Bestelldatum</dt>
                                    <dd>{{ selectedOrder.additional.orderDate }}</dd>
                                    <dt>Status</dt>
                                    <dd>{{ selectedOrder.additional.status }}</dd>
                                    <dt>Bestelltyp</dt>
                                    <dd>{{ selectedOrder.additional.orderType }}</dd>
                                    <dt>Notizen</dt>
                                    <dd>{{ selectedOrder.additional.notes }}</dd>
                                    <dt>Fachberater</dt>
                                    <dd>{{ selectedOrder.additional.consultant }}</dd>
                                    <dt>Mandant</dt>
                                    <dd>{{ selectedOrder.additional.tenant }}</dd>
                                    <dt>San6 Auftragsnummer</dt>
                                    <dd>{{ selectedOrder.additional.san6OrderNumber }}</dd>
                                </dl>
                            </div>
                            <div class="external-orders__detail-section">
                                <h4>Erweiterte Bestelldaten</h4>
                                <dl>
                                    <dt>Versanddienstleister</dt>
                                    <dd>{{ selectedOrder.shipping.carrier }}</dd>
                                    <dt>Trackingnummer(n)</dt>
                                    <dd>{{ selectedOrder.shipping.trackingNumbers.join(', ') }}</dd>
                                    <dt>Einträge in Orgas San6</dt>
                                    <dd>{{ selectedOrder.additional.orgaEntries.join(', ') }}</dd>
                                    <dt>Dokumente Bildarchiv San6</dt>
                                    <dd>{{ selectedOrder.additional.documents.join(', ') }}</dd>
                                    <dt>PDMS ID + Variante</dt>
                                    <dd>{{ selectedOrder.additional.pdmsId }} / {{ selectedOrder.additional.pdmsVariant }}</dd>
                                    <dt>TopM Artikelnummer + Ausführung</dt>
                                    <dd>{{ selectedOrder.additional.topmArticleNumber }} / {{ selectedOrder.additional.topmExecution }}</dd>
                                    <dt>Bestellstatushistorie</dt>
                                    <dd>{{ selectedOrder.additional.statusHistorySource }}</dd>
                                </dl>
                            </div>
                        </div>
                    </sw-card>

                    <sw-card title="Bestellprodukte" class="external-orders__detail-card">
                        <sw-data-grid
                            :data-source="selectedOrder.items"
                            :columns="[
                                { property: 'name', label: 'Produktname' },
                                { property: 'quantity', label: 'Menge' },
                                { property: 'netPrice', label: 'Nettowert' },
                                { property: 'taxRate', label: 'Steuersatz' },
                                { property: 'grossPrice', label: 'Bruttowert' },
                                { property: 'totalPrice', label: 'Gesamtwert' },
                            ]"
                            identifier="external-orders-items"
                        >
                            <template #column-netPrice="{ item }">
                                {{ formatCurrency(item.netPrice) }}
                            </template>
                            <template #column-taxRate="{ item }">
                                {{ item.taxRate }}%
                            </template>
                            <template #column-grossPrice="{ item }">
                                {{ formatCurrency(item.grossPrice) }}
                            </template>
                            <template #column-totalPrice="{ item }">
                                {{ formatCurrency(item.totalPrice) }}
                            </template>
                        </sw-data-grid>
                    </sw-card>

                    <sw-card title="Statusverlauf" class="external-orders__detail-card">
                        <sw-data-grid
                            :data-source="selectedOrder.statusHistory"
                            :columns="[
                                { property: 'status', label: 'Status' },
                                { property: 'date', label: 'Datum' },
                                { property: 'comment', label: 'Kommentare' },
                            ]"
                            identifier="external-orders-history"
                        />
                    </sw-card>

                    <sw-card title="Bestellgesamtsummen" class="external-orders__detail-card">
                        <div class="external-orders__totals">
                            <div class="external-orders__totals-row">
                                <span>Warenwert</span>
                                <span>{{ formatCurrency(selectedOrder.totals.items) }}</span>
                            </div>
                            <div class="external-orders__totals-row">
                                <span>Versandkosten</span>
                                <span>{{ formatCurrency(selectedOrder.totals.shipping) }}</span>
                            </div>
                            <div class="external-orders__totals-row">
                                <span>Summe</span>
                                <span>{{ formatCurrency(selectedOrder.totals.sum) }}</span>
                            </div>
                            <div class="external-orders__totals-row">
                                <span>inkl. MwSt.</span>
                                <span>{{ formatCurrency(selectedOrder.totals.tax) }}</span>
                            </div>
                            <div class="external-orders__totals-row">
                                <span>Summe netto</span>
                                <span>{{ formatCurrency(selectedOrder.totals.net) }}</span>
                            </div>
                        </div>
                    </sw-card>
                </div>
            </sw-modal>
        </div>
    </main>
</div>
