<div class="external-orders">
    <header class="external-orders__header">
        <h2>Bestellübersichten</h2>
    </header>

    <main id="main" class="sw-page__main-content" tabindex="-1">
        <div class="external-orders__page">
            <sw-card class="external-orders__channels" style="max-width: none; width: 100%;">
                <div class="external-orders__channel-tabs">
                    <button
                        v-for="channel in channels"
                        :key="channel.id"
                        class="external-orders__channel-tab"
                        :class="{ 'is--active': activeChannel === channel.id }"
                        type="button"
                        @click="activeChannel = channel.id; loadOrders()"
                    >
                        <span class="external-orders__channel-logo">
                            <img :src="channel.logo" :alt="channel.label" />
                        </span>
                        <span class="external-orders__channel-label">{{ channel.label }}</span>
                    </button>
                </div>
                <div class="external-orders__summary">
                    <div class="external-orders__summary-title">
                        <span>Bestellungen aus {{ activeChannelLabel }}</span>
                    </div>
                    <div
                        v-if="activeChannelSource"
                        class="external-orders__summary-source"
                    >
                        Quelle: {{ activeChannelSource }}
                    </div>
                    <div class="external-orders__summary-metrics">
                        <div class="external-orders__summary-item">
                            <span class="external-orders__summary-label">Bestellungen</span>
                            <span class="external-orders__summary-value">{{ summary.orderCount }}</span>
                        </div>
                        <div class="external-orders__summary-item">
                            <span class="external-orders__summary-label">Gesamtumsatz</span>
                            <span class="external-orders__summary-value">{{ formatCurrency(summary.totalRevenue) }}</span>
                        </div>
                        <div class="external-orders__summary-item">
                            <span class="external-orders__summary-label">Stück</span>
                            <span class="external-orders__summary-value">{{ summary.totalItems }}</span>
                        </div>
                    </div>
                    <div class="external-orders__summary-actions">
                        <sw-button
                            variant="primary"
                            size="small"
                            @click="exportSelectedOrdersPdf"
                        >
                            <sw-icon name="regular-file-text" size="16" class="external-orders__download-icon" />
                            PDF herunterladen ({{ selectedOrders.length > 0 ? selectedOrders.length : filteredOrders.length }})
                        </sw-button>
                        <sw-button
                            variant="secondary"
                            size="small"
                            @click="exportSelectedOrdersExcel"
                        >
                            <sw-icon name="regular-file" size="16" class="external-orders__download-icon" />
                            Excel herunterladen ({{ selectedOrders.length > 0 ? selectedOrders.length : filteredOrders.length }})
                        </sw-button>
                    </div>
                </div>
            </sw-card>

            <sw-card class="external-orders__filters-card" style="max-width: none; width: 100%;">
                <div class="external-orders__filters-bar">
                    <div class="external-orders__filters">
                        <sw-button variant="primary" size="small" @click="resetFilters">
                            <sw-icon name="regular-filter" size="16" />
                            Filter löschen
                        </sw-button>
                        <sw-datepicker placeholder="Start Datum" class="external-orders__date" size="small" date-type="date" />
                        <sw-datepicker placeholder="End Datum" class="external-orders__date" size="small" date-type="date" />
                        <sw-button variant="primary" size="small">Anwenden</sw-button>
                    </div>
                    <div class="external-orders__filters-actions">
                        <sw-text-field
                            v-model="tableSearchTerm"
                            placeholder="Suche Bestellungen"
                            class="external-orders__search"
                            type="search"
                        />
                        <sw-button
                            variant="primary"
                            size="small"
                            :disabled="!hasSelectedOrders"
                            @click="openTestMarkingModal"
                        >
                            Testmarkierung Anwenden
                        </sw-button>
                    </div>
                </div>

                <div
                    v-if="paginatedOrders.length > 0"
                    class="external-orders__table-wrapper"
                >
                    <table class="external-orders__table">
                        <thead>
                            <tr>
                                <th class="external-orders__cell external-orders__cell--checkbox">
                                    <input
                                        type="checkbox"
                                        class="external-orders__checkbox"
                                        :checked="isAllSelected"
                                        @change="toggleSelectAll($event)"
                                    />
                                </th>
                                <th class="external-orders__cell">
                                    <div class="external-orders__column-header">
                                        <button
                                            class="external-orders__column-sort"
                                            type="button"
                                            @click="onSortColumn('orderNumber')"
                                        >
                                            BestellNr
                                            <span class="external-orders__sort-indicator">
                                                {{ getSortIndicator('orderNumber') }}
                                            </span>
                                        </button>
                                        <button
                                            class="external-orders__column-filter-button"
                                            :class="{ 'is--active': isColumnFilterActive('orderNumber') }"
                                            type="button"
                                            @click.stop="toggleColumnFilter('orderNumber')"
                                        >
                                            <sw-icon name="regular-filter" size="16" />
                                        </button>
                                        <div
                                            v-if="activeColumnFilter === 'orderNumber'"
                                            class="external-orders__column-filter-panel"
                                            @click.stop
                                        >
                                            <sw-single-select
                                                v-model="columnFilterMatchMode"
                                                :options="columnFilterMatchOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-single-select
                                                v-model="columnFilters.orderNumber.operator"
                                                :options="columnFilterOperatorOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-text-field
                                                v-model="columnFilters.orderNumber.value"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-button
                                                variant="primary"
                                                size="small"
                                                class="external-orders__column-filter-add"
                                                disabled
                                            >
                                                + Add Rule
                                            </sw-button>
                                            <div class="external-orders__column-filter-actions">
                                                <sw-button
                                                    variant="secondary"
                                                    size="small"
                                                    @click="clearColumnFilter('orderNumber')"
                                                >
                                                    Clear
                                                </sw-button>
                                                <sw-button
                                                    variant="primary"
                                                    size="small"
                                                    @click="applyColumnFilter"
                                                >
                                                    Apply
                                                </sw-button>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th class="external-orders__cell">
                                    <div class="external-orders__column-header">
                                        <button
                                            class="external-orders__column-sort"
                                            type="button"
                                            @click="onSortColumn('customerName')"
                                        >
                                            Kundenname
                                            <span class="external-orders__sort-indicator">
                                                {{ getSortIndicator('customerName') }}
                                            </span>
                                        </button>
                                        <button
                                            class="external-orders__column-filter-button"
                                            :class="{ 'is--active': isColumnFilterActive('customerName') }"
                                            type="button"
                                            @click.stop="toggleColumnFilter('customerName')"
                                        >
                                            <sw-icon name="regular-filter" size="16" />
                                        </button>
                                        <div
                                            v-if="activeColumnFilter === 'customerName'"
                                            class="external-orders__column-filter-panel"
                                            @click.stop
                                        >
                                            <sw-single-select
                                                v-model="columnFilterMatchMode"
                                                :options="columnFilterMatchOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-single-select
                                                v-model="columnFilters.customerName.operator"
                                                :options="columnFilterOperatorOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-text-field
                                                v-model="columnFilters.customerName.value"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-button
                                                variant="primary"
                                                size="small"
                                                class="external-orders__column-filter-add"
                                                disabled
                                            >
                                                + Add Rule
                                            </sw-button>
                                            <div class="external-orders__column-filter-actions">
                                                <sw-button
                                                    variant="secondary"
                                                    size="small"
                                                    @click="clearColumnFilter('customerName')"
                                                >
                                                    Clear
                                                </sw-button>
                                                <sw-button
                                                    variant="primary"
                                                    size="small"
                                                    @click="applyColumnFilter"
                                                >
                                                    Apply
                                                </sw-button>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th class="external-orders__cell">
                                    <div class="external-orders__column-header">
                                        <button
                                            class="external-orders__column-sort"
                                            type="button"
                                            @click="onSortColumn('orderReference')"
                                        >
                                            AuftragsNr
                                            <span class="external-orders__sort-indicator">
                                                {{ getSortIndicator('orderReference') }}
                                            </span>
                                        </button>
                                        <button
                                            class="external-orders__column-filter-button"
                                            :class="{ 'is--active': isColumnFilterActive('orderReference') }"
                                            type="button"
                                            @click.stop="toggleColumnFilter('orderReference')"
                                        >
                                            <sw-icon name="regular-filter" size="16" />
                                        </button>
                                        <div
                                            v-if="activeColumnFilter === 'orderReference'"
                                            class="external-orders__column-filter-panel"
                                            @click.stop
                                        >
                                            <sw-single-select
                                                v-model="columnFilterMatchMode"
                                                :options="columnFilterMatchOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-single-select
                                                v-model="columnFilters.orderReference.operator"
                                                :options="columnFilterOperatorOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-text-field
                                                v-model="columnFilters.orderReference.value"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-button
                                                variant="primary"
                                                size="small"
                                                class="external-orders__column-filter-add"
                                                disabled
                                            >
                                                + Add Rule
                                            </sw-button>
                                            <div class="external-orders__column-filter-actions">
                                                <sw-button
                                                    variant="secondary"
                                                    size="small"
                                                    @click="clearColumnFilter('orderReference')"
                                                >
                                                    Clear
                                                </sw-button>
                                                <sw-button
                                                    variant="primary"
                                                    size="small"
                                                    @click="applyColumnFilter"
                                                >
                                                    Apply
                                                </sw-button>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th class="external-orders__cell">
                                    <div class="external-orders__column-header">
                                        <button
                                            class="external-orders__column-sort"
                                            type="button"
                                            @click="onSortColumn('email')"
                                        >
                                            Email
                                            <span class="external-orders__sort-indicator">
                                                {{ getSortIndicator('email') }}
                                            </span>
                                        </button>
                                        <button
                                            class="external-orders__column-filter-button"
                                            :class="{ 'is--active': isColumnFilterActive('email') }"
                                            type="button"
                                            @click.stop="toggleColumnFilter('email')"
                                        >
                                            <sw-icon name="regular-filter" size="16" />
                                        </button>
                                        <div
                                            v-if="activeColumnFilter === 'email'"
                                            class="external-orders__column-filter-panel"
                                            @click.stop
                                        >
                                            <sw-single-select
                                                v-model="columnFilterMatchMode"
                                                :options="columnFilterMatchOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-single-select
                                                v-model="columnFilters.email.operator"
                                                :options="columnFilterOperatorOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-text-field
                                                v-model="columnFilters.email.value"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-button
                                                variant="primary"
                                                size="small"
                                                class="external-orders__column-filter-add"
                                                disabled
                                            >
                                                + Add Rule
                                            </sw-button>
                                            <div class="external-orders__column-filter-actions">
                                                <sw-button
                                                    variant="secondary"
                                                    size="small"
                                                    @click="clearColumnFilter('email')"
                                                >
                                                    Clear
                                                </sw-button>
                                                <sw-button
                                                    variant="primary"
                                                    size="small"
                                                    @click="applyColumnFilter"
                                                >
                                                    Apply
                                                </sw-button>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th class="external-orders__cell">
                                    <div class="external-orders__column-header">
                                        <button
                                            class="external-orders__column-sort"
                                            type="button"
                                            @click="onSortColumn('date')"
                                        >
                                            Datum
                                            <span class="external-orders__sort-indicator">
                                                {{ getSortIndicator('date') }}
                                            </span>
                                        </button>
                                        <button
                                            class="external-orders__column-filter-button"
                                            :class="{ 'is--active': isColumnFilterActive('date') }"
                                            type="button"
                                            @click.stop="toggleColumnFilter('date')"
                                        >
                                            <sw-icon name="regular-filter" size="16" />
                                        </button>
                                        <div
                                            v-if="activeColumnFilter === 'date'"
                                            class="external-orders__column-filter-panel"
                                            @click.stop
                                        >
                                            <sw-single-select
                                                v-model="columnFilterMatchMode"
                                                :options="columnFilterMatchOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-single-select
                                                v-model="columnFilters.date.operator"
                                                :options="columnFilterOperatorOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-text-field
                                                v-model="columnFilters.date.value"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-button
                                                variant="primary"
                                                size="small"
                                                class="external-orders__column-filter-add"
                                                disabled
                                            >
                                                + Add Rule
                                            </sw-button>
                                            <div class="external-orders__column-filter-actions">
                                                <sw-button
                                                    variant="secondary"
                                                    size="small"
                                                    @click="clearColumnFilter('date')"
                                                >
                                                    Clear
                                                </sw-button>
                                                <sw-button
                                                    variant="primary"
                                                    size="small"
                                                    @click="applyColumnFilter"
                                                >
                                                    Apply
                                                </sw-button>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th class="external-orders__cell">
                                    <div class="external-orders__column-header">
                                        <button
                                            class="external-orders__column-sort"
                                            type="button"
                                            @click="onSortColumn('statusLabel')"
                                        >
                                            Bestellstatus
                                            <span class="external-orders__sort-indicator">
                                                {{ getSortIndicator('statusLabel') }}
                                            </span>
                                        </button>
                                        <button
                                            class="external-orders__column-filter-button"
                                            :class="{ 'is--active': isColumnFilterActive('statusLabel') }"
                                            type="button"
                                            @click.stop="toggleColumnFilter('statusLabel')"
                                        >
                                            <sw-icon name="regular-filter" size="16" />
                                        </button>
                                        <div
                                            v-if="activeColumnFilter === 'statusLabel'"
                                            class="external-orders__column-filter-panel"
                                            @click.stop
                                        >
                                            <sw-single-select
                                                v-model="columnFilterMatchMode"
                                                :options="columnFilterMatchOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-single-select
                                                v-model="columnFilters.statusLabel.operator"
                                                :options="columnFilterOperatorOptions"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-text-field
                                                v-model="columnFilters.statusLabel.value"
                                                size="small"
                                                class="external-orders__column-filter-field"
                                            />
                                            <sw-button
                                                variant="primary"
                                                size="small"
                                                class="external-orders__column-filter-add"
                                                disabled
                                            >
                                                + Add Rule
                                            </sw-button>
                                            <div class="external-orders__column-filter-actions">
                                                <sw-button
                                                    variant="secondary"
                                                    size="small"
                                                    @click="clearColumnFilter('statusLabel')"
                                                >
                                                    Clear
                                                </sw-button>
                                                <sw-button
                                                    variant="primary"
                                                    size="small"
                                                    @click="applyColumnFilter"
                                                >
                                                    Apply
                                                </sw-button>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                <th class="external-orders__cell external-orders__cell--actions">
                                    Ansicht
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="order in paginatedOrders" :key="getOrderKey(order)">
                                <td class="external-orders__cell external-orders__cell--checkbox">
                                    <input
                                        type="checkbox"
                                        class="external-orders__checkbox"
                                        :checked="isOrderSelected(order)"
                                        @change="toggleOrderSelection(order, $event)"
                                    />
                                </td>
                                <td class="external-orders__cell">{{ order.orderNumber }}</td>
                                <td class="external-orders__cell">{{ order.customerName }}</td>
                                <td class="external-orders__cell">{{ order.orderReference }}</td>
                                <td class="external-orders__cell">{{ order.email }}</td>
                                <td class="external-orders__cell">{{ order.date }}</td>
                                <td class="external-orders__cell">
                                    <sw-label :variant="statusVariant(order.status)" size="small">
                                        {{ order.statusLabel }}
                                    </sw-label>
                                </td>
                                <td class="external-orders__cell external-orders__cell--actions">
                                    <sw-button
                                        variant="ghost"
                                        size="small"
                                        class="external-orders__action"
                                        @click="openDetail(order)"
                                    >
                                        <sw-icon name="regular-eye" size="16" />
                                    </sw-button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div
                    v-if="paginatedOrders.length > 0"
                    class="external-orders__pagination"
                >
                    <div class="external-orders__pagination-controls">
                        <button
                            type="button"
                            class="external-orders__pagination-nav"
                            :disabled="page <= 1"
                            @click="goToFirstPage"
                        >
                            «
                        </button>
                        <button
                            type="button"
                            class="external-orders__pagination-nav"
                            :disabled="page <= 1"
                            @click="goToPreviousPage"
                        >
                            ‹
                        </button>
                        <div class="external-orders__pagination-pages">
                            <button
                                v-for="pageNumber in visiblePages"
                                :key="pageNumber"
                                type="button"
                                class="external-orders__pagination-page"
                                :class="{ 'is--active': pageNumber === page }"
                                @click="goToPage(pageNumber)"
                            >
                                {{ pageNumber }}
                            </button>
                        </div>
                        <button
                            type="button"
                            class="external-orders__pagination-nav"
                            :disabled="page >= totalPages"
                            @click="goToNextPage"
                        >
                            ›
                        </button>
                        <button
                            type="button"
                            class="external-orders__pagination-nav"
                            :disabled="page >= totalPages"
                            @click="goToLastPage"
                        >
                            »
                        </button>
                        <sw-single-select
                            v-model="limit"
                            :options="limitSelectOptions"
                            size="small"
                            class="external-orders__pagination-limit"
                            @change="onLimitChange"
                        />
                    </div>
                </div>
                <sw-empty-state
                    v-else
                    icon="regular-shopping-cart"
                    title="Keine Bestellungen gefunden"
                    subline="Es wurden keine Bestellungen für die aktuelle Auswahl geladen."
                />
            </sw-card>

            <div
                v-if="showDetailModal && selectedOrder"
                class="external-orders__detail-overlay"
                role="dialog"
                aria-modal="true"
            >
                <div class="external-orders__detail-dialog">
                    <header class="external-orders__detail-header">
                        <h3>Bestellübersicht für {{ selectedOrder.orderNumber }}</h3>
                        <button
                            type="button"
                            class="external-orders__detail-close"
                            aria-label="Modal schließen"
                            @click="closeDetail"
                        >
                            ×
                        </button>
                    </header>
                    <div class="external-orders__detail-body">
                        <div class="external-orders__detail">
                            <sw-card title="Zusätzliche Bestellinformationen" class="external-orders__detail-card">
                                <div class="external-orders__detail-grid">
                                    <div class="external-orders__detail-section">
                                        <h4>Kundendetails</h4>
                                        <dl>
                                            <dt>Kundenname</dt>
                                            <dd>{{ selectedOrder.customer.firstName }} {{ selectedOrder.customer.lastName }}</dd>
                                            <dt>Kundennummer</dt>
                                            <dd>{{ selectedOrder.customer.number }}</dd>
                                            <dt>Vorname</dt>
                                            <dd>{{ selectedOrder.customer.firstName }}</dd>
                                            <dt>Nachname</dt>
                                            <dd>{{ selectedOrder.customer.lastName }}</dd>
                                            <dt>Kunden-Mail-Adresse</dt>
                                            <dd>{{ selectedOrder.customer.email }}</dd>
                                            <dt>Kundengruppe</dt>
                                            <dd>{{ selectedOrder.customer.group }}</dd>
                                        </dl>
                                    </div>
                                    <div class="external-orders__detail-section">
                                        <h4>Zahlungsdetails</h4>
                                        <dl>
                                            <dt>Zahlungsmethode</dt>
                                            <dd>{{ selectedOrder.payment.method }}</dd>
                                            <dt>Zahlungscode</dt>
                                            <dd>{{ selectedOrder.payment.code }}</dd>
                                            <dt>Fälligkeitsdatum</dt>
                                            <dd>{{ selectedOrder.payment.dueDate }}</dd>
                                            <dt>Ausstehender Betrag</dt>
                                            <dd>{{ selectedOrder.payment.outstanding }}</dd>
                                            <dt>Abgerechnet</dt>
                                            <dd>{{ selectedOrder.payment.settled }}</dd>
                                            <dt>Zusatzinfo</dt>
                                            <dd>{{ selectedOrder.payment.extra }}</dd>
                                        </dl>
                                    </div>
                                    <div class="external-orders__detail-section">
                                        <h4>Rechnungsanschrift</h4>
                                        <dl>
                                            <dt>Straße</dt>
                                            <dd>{{ selectedOrder.billingAddress.street }}</dd>
                                            <dt>PLZ</dt>
                                            <dd>{{ selectedOrder.billingAddress.zip }}</dd>
                                            <dt>Stadt</dt>
                                            <dd>{{ selectedOrder.billingAddress.city }}</dd>
                                            <dt>Land</dt>
                                            <dd>{{ selectedOrder.billingAddress.country }}</dd>
                                        </dl>
                                    </div>
                                    <div class="external-orders__detail-section">
                                        <h4>Lieferanschrift</h4>
                                        <dl>
                                            <dt>Lieferadresse</dt>
                                            <dd>{{ selectedOrder.shippingAddress.name }}</dd>
                                            <dt>Lieferstraße</dt>
                                            <dd>{{ selectedOrder.shippingAddress.street }}</dd>
                                            <dt>Postleitzahl/Stadt</dt>
                                            <dd>{{ selectedOrder.shippingAddress.zipCity }}</dd>
                                            <dt>Land</dt>
                                            <dd>{{ selectedOrder.shippingAddress.country }}</dd>
                                        </dl>
                                    </div>
                                    <div class="external-orders__detail-section">
                                        <h4>Weitere Details</h4>
                                        <dl>
                                            <dt>Bestelldatum</dt>
                                            <dd>{{ selectedOrder.additional.orderDate }}</dd>
                                            <dt>Status</dt>
                                            <dd>{{ selectedOrder.additional.status }}</dd>
                                            <dt>Bestelltyp</dt>
                                            <dd>{{ selectedOrder.additional.orderType }}</dd>
                                            <dt>Notizen</dt>
                                            <dd>{{ selectedOrder.additional.notes }}</dd>
                                            <dt>Fachberater</dt>
                                            <dd>{{ selectedOrder.additional.consultant }}</dd>
                                            <dt>Mandant</dt>
                                            <dd>{{ selectedOrder.additional.tenant }}</dd>
                                            <dt>San6 Auftragsnummer</dt>
                                            <dd>{{ selectedOrder.additional.san6OrderNumber }}</dd>
                                        </dl>
                                    </div>
                                    <div class="external-orders__detail-section">
                                        <h4>Erweiterte Bestelldaten</h4>
                                        <dl>
                                            <dt>Versanddienstleister</dt>
                                            <dd>{{ selectedOrder.shipping.carrier }}</dd>
                                            <dt>Trackingnummer(n)</dt>
                                            <dd>{{ selectedOrder.shipping.trackingNumbers.join(', ') }}</dd>
                                            <dt>Einträge in Orgas San6</dt>
                                            <dd>{{ selectedOrder.additional.orgaEntries.join(', ') }}</dd>
                                            <dt>Dokumente aus Bildarchiv San6</dt>
                                            <dd>{{ selectedOrder.additional.documents.join(', ') }}</dd>
                                            <dt>PDMS ID + Variante</dt>
                                            <dd>{{ selectedOrder.additional.pdmsId }} / {{ selectedOrder.additional.pdmsVariant }}</dd>
                                            <dt>TopM Artikelnummer + Ausführung</dt>
                                            <dd>{{ selectedOrder.additional.topmArticleNumber }} / {{ selectedOrder.additional.topmExecution }}</dd>
                                            <dt>Bestellstatushistorie Gambio/Shopware</dt>
                                            <dd>{{ selectedOrder.additional.statusHistorySource }}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </sw-card>

                            <sw-card title="Bestellprodukte" class="external-orders__detail-card">
                                <sw-data-grid
                                    :data-source="selectedOrder.items"
                                    :columns="[
                                        { property: 'name', label: 'Produktname' },
                                        { property: 'quantity', label: 'Menge' },
                                        { property: 'netPrice', label: 'Nettowert' },
                                        { property: 'taxRate', label: 'Steuersatz' },
                                        { property: 'grossPrice', label: 'Bruttowert' },
                                        { property: 'totalPrice', label: 'Gesamtwert' },
                                    ]"
                                    identifier="external-orders-items"
                                >
                                    <template #column-netPrice="{ item }">
                                        {{ formatCurrency(item.netPrice) }}
                                    </template>
                                    <template #column-taxRate="{ item }">
                                        {{ item.taxRate }}%
                                    </template>
                                    <template #column-grossPrice="{ item }">
                                        {{ formatCurrency(item.grossPrice) }}
                                    </template>
                                    <template #column-totalPrice="{ item }">
                                        {{ formatCurrency(item.totalPrice) }}
                                    </template>
                                </sw-data-grid>
                            </sw-card>

                            <sw-card title="Statusverlauf" class="external-orders__detail-card">
                                <sw-data-grid
                                    :data-source="selectedOrder.statusHistory"
                                    :columns="[
                                        { property: 'status', label: 'Status' },
                                        { property: 'date', label: 'Datum' },
                                        { property: 'comment', label: 'Kommentare' },
                                    ]"
                                    identifier="external-orders-history"
                                />
                            </sw-card>

                            <sw-card title="Bestellgesamtsummen" class="external-orders__detail-card">
                                <div class="external-orders__totals">
                                    <div class="external-orders__totals-row">
                                        <span>Warenwert</span>
                                        <span>{{ formatCurrency(selectedOrder.totals.items) }}</span>
                                    </div>
                                    <div class="external-orders__totals-row">
                                        <span>Versandkosten</span>
                                        <span>{{ formatCurrency(selectedOrder.totals.shipping) }}</span>
                                    </div>
                                    <div class="external-orders__totals-row">
                                        <span>Summe</span>
                                        <span>{{ formatCurrency(selectedOrder.totals.sum) }}</span>
                                    </div>
                                    <div class="external-orders__totals-row">
                                        <span>inkl. MwSt.</span>
                                        <span>{{ formatCurrency(selectedOrder.totals.tax) }}</span>
                                    </div>
                                    <div class="external-orders__totals-row">
                                        <span>Summe netto</span>
                                        <span>{{ formatCurrency(selectedOrder.totals.net) }}</span>
                                    </div>
                                </div>
                            </sw-card>
                        </div>
                    </div>
                </div>
            </div>

            <sw-modal
                v-if="showTestMarkingModal"
                title="Bestätigen von Änderungen der Testmarkierung"
                variant="medium"
                class="external-orders__testmarking-modal"
                @modal-close="closeTestMarkingModal"
            >
                <p class="external-orders__testmarking-intro">
                    Sie sind dabei, die folgenden Bestellungen als Testbestellungen zu markieren bzw. die Markierung
                    aufzuheben. Bitte überprüfen Sie die Änderungen, bevor Sie sie bestätigen.
                </p>
                <div class="external-orders__testmarking-grid">
                    <div class="external-orders__testmarking-card">
                        <h4 class="external-orders__testmarking-title is--positive">
                            Als Test zu markierende Bestellungen
                        </h4>
                        <ul class="external-orders__testmarking-list">
                            <li
                                v-for="order in testMarkingOrders"
                                :key="getOrderKey(order)"
                            >
                                {{ getOrderDisplayLabel(order) }}
                            </li>
                            <li v-if="testMarkingOrders.length === 0">
                                Keine Bestellungen ausgewählt.
                            </li>
                        </ul>
                    </div>
                    <div class="external-orders__testmarking-card">
                        <h4 class="external-orders__testmarking-title is--negative">
                            Bestellungen, die nicht als Test markieren
                        </h4>
                        <ul class="external-orders__testmarking-list">
                            <li
                                v-for="order in unmarkedTestOrders"
                                :key="getOrderKey(order)"
                            >
                                {{ getOrderDisplayLabel(order) }}
                            </li>
                            <li v-if="unmarkedTestOrders.length === 0">
                                Keine Bestellungen ausgewählt.
                            </li>
                        </ul>
                    </div>
                </div>
                <template #modal-footer>
                    <sw-button variant="secondary" @click="closeTestMarkingModal">
                        Abbrechen
                    </sw-button>
                    <sw-button variant="primary" @click="applyTestMarking">
                        Bestätige
                    </sw-button>
                </template>
            </sw-modal>
        </div>
    </main>
</div>
