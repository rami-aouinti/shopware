{% block lieferzeiten_order_table %}
    <div class="lieferzeiten-order-table">
        <table class="sw-data-grid__table">
            <thead>
                <tr>
                    <th colspan="4">{{ $t('lieferzeiten.zones.order') }}</th>
                    <th colspan="5">{{ $t('lieferzeiten.zones.delivery') }}</th>
                    <th colspan="3">{{ $t('lieferzeiten.zones.status') }}</th>
                </tr>
                <tr>
                    <th>{{ $t('lieferzeiten.table.orderNumber') }}</th>
                    <th>{{ $t('lieferzeiten.table.domain') }}</th>
                    <th>{{ $t('lieferzeiten.table.positions') }}</th>
                    <th>{{ $t('lieferzeiten.table.parcels') }}</th>
                    <th>{{ $t('lieferzeiten.fields.supplierDate') }}</th>
                    <th>{{ $t('lieferzeiten.fields.supplierWeek') }}</th>
                    <th>{{ $t('lieferzeiten.fields.newDate') }}</th>
                    <th>{{ $t('lieferzeiten.fields.comment') }}</th>
                    <th>{{ $t('lieferzeiten.fields.history') }}</th>
                    <th>{{ $t('lieferzeiten.table.status') }}</th>
                    <th>{{ $t('lieferzeiten.fields.shippingType') }}</th>
                    <th>{{ $t('lieferzeiten.fields.audit') }}</th>
                </tr>
            </thead>
            <tbody>
                <template v-for="order in displayedOrders">
                    <tr :key="order.id">
                        <td>
                            <sw-button size="small" variant="ghost" @click="toggleOrder(order.id)">
                                {{ isExpanded(order.id) ? '-' : '+' }}
                            </sw-button>
                            {{ order.orderNumber }}
                        </td>
                        <td>{{ order.domain }}</td>
                        <td>{{ order.positions.length }}</td>
                        <td>{{ parcelSummary(order) }}</td>
                        <td>
                            <sw-number-field
                                v-model:value="order.lieferterminLieferantDays"
                                :min="1"
                                :max="14"
                                :disabled="!hasEditAccess()"
                                size="small"
                            />
                            <sw-button size="small" variant="primary" :disabled="!hasEditAccess() || !canSaveLiefertermin(order)" @click="saveLiefertermin(order)">
                                {{ $t('global.default.save') }}
                            </sw-button>
                        </td>
                        <td>{{ order.lieferterminLieferantKw || '-' }}</td>
                        <td>
                            <sw-number-field
                                v-model:value="order.neuerLieferterminDays"
                                :min="1"
                                :max="4"
                                :disabled="!hasEditAccess() || !order.lieferterminLieferantDays"
                                size="small"
                            />
                            <sw-button size="small" variant="primary" :disabled="!hasEditAccess() || !canSaveNeuerLiefertermin(order)" @click="saveNeuerLiefertermin(order)">
                                {{ $t('global.default.save') }}
                            </sw-button>
                        </td>
                        <td>
                            <sw-text-field v-model:value="order.comment" :disabled="!hasEditAccess()" size="small" />
                            <sw-button size="small" :disabled="!hasEditAccess()" @click="saveComment(order)">
                                {{ $t('global.default.save') }}
                            </sw-button>
                            <sw-button size="small" variant="ghost" :disabled="!hasEditAccess()" @click="requestAdditionalDeliveryDate(order)">
                                {{ $t('lieferzeiten.additionalRequest.button') }}
                            </sw-button>
                        </td>
                        <td>
                            <ul>
                                <li v-for="entry in order.lieferterminLieferantHistory" :key="entry">{{ entry }}</li>
                                <li v-for="entry in order.neuerLieferterminHistory" :key="entry">{{ entry }}</li>
                                <li v-for="entry in order.commentHistory" :key="entry">{{ entry }}</li>
                            </ul>
                        </td>
                        <td>
                            <sw-label :variant="isOrderOpen(order) ? 'warning' : 'success'">
                                {{ isOrderOpen(order) ? $t('lieferzeiten.status.open') : $t('lieferzeiten.status.closed') }}
                            </sw-label>
                        </td>
                        <td>{{ shippingLabel(order) }}</td>
                        <td>{{ order.audit || '-' }}</td>
                    </tr>
                    <tr v-if="isExpanded(order.id)" :key="`${order.id}-positions`">
                        <td colspan="12">
                            <table class="sw-data-grid__table">
                                <thead>
                                    <tr>
                                        <th>{{ $t('lieferzeiten.table.position') }}</th>
                                        <th>{{ $t('lieferzeiten.table.article') }}</th>
                                        <th>{{ $t('lieferzeiten.table.quantity') }}</th>
                                        <th>{{ $t('lieferzeiten.table.packageNumbers') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="position in order.positions" :key="position.id">
                                        <td>{{ position.number }}</td>
                                        <td>{{ position.label }}</td>
                                        <td>{{ position.quantity }}</td>
                                        <td>
                                            <template v-for="entry in resolveTrackingEntries(order, position)">
                                                <button
                                                    :key="`${position.id}-${entry.number}`"
                                                    type="button"
                                                    class="lieferzeiten-order-table__tracking-link"
                                                    @click="openTrackingHistory(entry)"
                                                >
                                                    {{ entry.number }}
                                                </button>
                                            </template>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>


        <div
            v-if="showTrackingModal"
            class="lieferzeiten-order-table__tracking-overlay"
            role="dialog"
            aria-modal="true"
        >
            <div class="lieferzeiten-order-table__tracking-dialog">
                <header class="lieferzeiten-order-table__tracking-header">
                    <h3>
                        Tracking {{ activeTracking && activeTracking.carrier && activeTracking.carrier.toUpperCase() }} / {{ activeTracking && activeTracking.number }}
                    </h3>
                    <button type="button" class="lieferzeiten-order-table__tracking-close" @click="closeTrackingModal">×</button>
                </header>

                <div class="lieferzeiten-order-table__tracking-body">
                    <div v-if="isTrackingLoading">{{ $t('lieferzeiten.tracking.loading') }}</div>
                    <div v-else-if="trackingError" class="lieferzeiten-order-table__tracking-error">{{ trackingError }}</div>
                    <div v-else-if="!trackingEvents.length">{{ $t('lieferzeiten.tracking.empty') }}</div>
                    <ul v-else class="lieferzeiten-order-table__tracking-list">
                        <li v-for="(event, index) in trackingEvents" :key="`${event.timestamp}-${index}`">
                            <strong>{{ event.status }}</strong>
                            <div>{{ event.label }}</div>
                            <small>{{ event.timestamp }}<span v-if="event.location"> · {{ event.location }}</span></small>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <sw-empty-state
            v-if="displayedOrders.length === 0"
            :title="$t('lieferzeiten.emptyState.title')"
            :description="$t('lieferzeiten.emptyState.description')"
        />
    </div>
{% endblock %}
